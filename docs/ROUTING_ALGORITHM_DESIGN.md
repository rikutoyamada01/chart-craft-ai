# Auto-Routing Algorithm Design

## 1. Overview

The goal of the auto-routing system is to automatically generate clean, readable, and orthogonal (Manhattan-style) wiring for circuit diagrams. This eliminates the need for manual wire path definition, improving both the efficiency of circuit creation and the visual clarity of the final schematic.

The core of the system is an **A* (A-Star) pathfinding algorithm** that operates on a virtual grid representing the drawing canvas.

## 2. Core Concepts

### 2.1. Grid System

The entire drawing area is modeled as a grid. Components, their safety margins, and the wires themselves occupy cells within this grid. The A* algorithm searches for a path from a start port to an end port through these grid cells.

### 2.2. Obstacle Model

To produce high-quality routes, the algorithm uses a two-tiered obstacle model:

-   **Hard Obstacles:** These represent the core bodies of components. They are considered completely **impassable**. The routing algorithm can never generate a path that crosses a hard obstacle.

-   **Soft Obstacles:** These represent areas that are valid for routing but should be avoided if possible. A path can cross a soft obstacle, but it will incur a significant movement cost, making it a less desirable option. There are two types of soft obstacles:
    1.  A safety margin area immediately surrounding each component's hard obstacle boundary.
    2.  The grid cells occupied by any previously routed wire.

This two-tiered system is critical for ensuring that a path can always be found if one is physically possible, while still guiding the algorithm to produce clean layouts that respect component spacing and avoid wire-crossings.

## 3. Pathfinding Strategy

### 3.1. Multi-Stage Search

To prioritize path quality, the algorithm doesn't just find any path; it actively seeks the "best" path by making several attempts with different penalties for crossing soft obstacles (i.e., existing wires).

1.  **Stage 1 (High Cost):** The initial search uses a high penalty for crossing soft obstacles. This encourages the router to find a clean path that doesn't cross any other wires.
2.  **Stage 2 (Medium Cost):** If the first stage fails, the penalty is lowered. This allows the router to cross other wires if necessary, but it will still prefer a non-crossing path if a reasonably short one exists.
3.  **Stage 3 (Zero Cost):** In the most constrained scenarios, if a path still hasn't been found, the penalty is removed entirely. This is a fallback to ensure a connection is made if it's at all possible, even if it's visually imperfect.

### 3.2. Port Egress

To ensure wires leave components cleanly and in the correct direction, the algorithm incorporates two key features:

1.  **Clearance Area:** A small area of the grid around the start and end ports is temporarily cleared of all obstacles. This prevents a component's own body from immediately blocking the pathfinding search.
2.  **Preferred Direction:** Each port has a defined egress direction (up, down, left, or right). The A* cost function applies a very high penalty if the path's first step does not follow this preferred direction, effectively forcing the wire to exit the port cleanly.

## 4. A* Cost Function

The heart of the intelligent routing behavior lies in a sophisticated cost function (`_cost_to_move`). The total cost to move from one grid cell to the next is a sum of multiple weighted penalties, which are evaluated in a strict priority order.

1.  **Base Cost:** A standard cost for moving one grid cell.
2.  **Adjacent to Hard Obstacle Penalty:** An ultra-high penalty applied to any cell directly next to a hard obstacle. This forces wires to keep a clear distance from component bodies.
3.  **Preferred Direction Penalty:** A very high penalty for failing to leave the start port in its designated direction.
4.  **Turn Penalty:** A high penalty for making a turn (changing from horizontal to vertical or vice-versa). This encourages the algorithm to find paths with the minimum number of bends. The penalty is increased dramatically when near the destination to prevent the path from overshooting and turning back on itself.
5.  **Soft Obstacle Penalty:** A medium penalty for crossing an existing wire. The exact value is determined by the multi-stage search strategy.
6.  **Macro Direction Penalty:** A small, graded penalty for moving perpendicular to the overall direction of the target. For example, if the target is far to the right, any vertical movement incurs a small penalty. This discourages large, unnecessary detours.
7.  **Proximity Penalty:** A low, distance-based penalty for being near any obstacle. This acts as a final nudge to center wires within empty channels, away from components.

## 5. Path Smoothing

The raw path generated by the A* algorithm is a list of every single grid cell along the route. To create a clean SVG polyline, a smoothing function (`_smooth_path`) processes this list and removes all redundant points, keeping only the start point, the end point, and the corner points where the path changes direction.
