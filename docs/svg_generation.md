## 6. YAMLからSVGを生成する方法

このYAML仕様から回路図のSVGを生成するには、以下のステップと考慮事項があります。

### 6.1. 概要

1.  **YAMLのパース**: YAMLファイルをプログラムで読み込み、対応するデータ構造（例: Pythonの辞書、JavaScriptのオブジェクト）に変換します。
2.  **データ解釈**: 読み込んだデータから、各コンポーネントの種類、ID、プロパティ（位置、回転、値など）、および接続情報を解釈します。
3.  **SVG要素へのマッピング**:
    *   **コンポーネント**: 各コンポーネントタイプ（`resistor`, `led`, `battery`, `junction`, `module`など）に対応するSVGの図形やシンボルを定義し、YAMLで指定された位置と回転を適用して描画します。
    *   **接続**: 接続情報に基づいて、コンポーネントの端子間を線やパスで結びます。分岐配線は`junction`コンポーネントを介して処理されます。
    *   **テキスト/ラベル**: コンポーネントのID、値、その他のプロパティをSVGのテキスト要素として描画します。
    *   **モジュール**: モジュールはグループ化されたSVG要素として表現し、内部コンポーネントはモジュールの位置を基準とした相対位置で描画します。
4.  **SVGの出力**: 生成されたSVGのXML文字列をファイルとして保存するか、Webページに埋め込みます。

### 6.2. 推奨されるアプローチ：ハイブリッド生成

SVG生成と他形式へのエクスポートの要件を考慮すると、**バックエンドでの生成を主軸とし、フロントエンドでのインタラクティブな表示をオプションとするハイブリッドアプローチ**が最も柔軟で強力です。

#### バックエンド (Python) でのコア生成とエクスポート

*   **役割**: YAMLをパースし、SVGを生成する主要なロジックを実装します。また、生成したSVGを基に、PNG、PDFなどの他の形式へ変換する機能も担当します。
*   **利点**: エクスポート機能が一元化され、堅牢になります。クライアントの性能に依存せず、複雑な回路の処理やバッチ処理に適しています。
*   **ツール**:
    *   `PyYAML`: YAMLファイルのパース。
    *   `svgwrite`: PythonからSVGファイルを生成するためのライブラリ。
    *   `lxml`: XML（SVGも含む）を操作するための強力なライブラリ。
*   **フロー**:
    1.  PythonスクリプトでYAMLファイルを読み込む。
    2.  YAMLデータを解析し、コンポーネントと接続の情報を抽出。
    3.  `svgwrite`などのライブラリを使用して、各コンポーネントのシンボル、位置、回転を考慮してSVG要素を作成。
    4.  接続情報に基づいて、コンポーネント間を線で結ぶSVG要素を作成。
    5.  最終的なSVG XMLを文字列として生成し、ファイルに保存するか、API経由でフロントエンドに渡す。

#### フロントエンド (JavaScript/TypeScript) でのインタラクティブ表示 (オプション)

*   **役割**: バックエンドからYAMLデータ、またはバックエンドで生成されたSVGを受け取り、インタラクティブな回路図を表示します。
*   **利点**: ユーザーインターフェースとの連携が容易で、リッチなユーザー体験（ズーム、パン、ドラッグなど）を提供できます。
*   **ツール**:
    *   `js-yaml`: YAMLファイルのパース。
    *   `D3.js`: データ駆動型ドキュメントの操作に強く、SVG要素の生成と操作に非常に強力です。
    *   `Konva.js`, `Paper.js`: より高レベルなグラフィックライブラリで、インタラクティブな描画に適しています。
    *   直接的なSVG DOM操作: `document.createElementNS('http://www.w3.org/2000/svg', 'rect')`などを用いて、生のSVG要素を生成・操作します。
*   **フロー**:
    1.  フロントエンドでYAMLデータ（バックエンドから取得、または直接読み込み）をパース。
    2.  JavaScript/TypeScriptでYAMLデータを解析し、コンポーネントと接続の情報を抽出。
    3.  `D3.js`などのライブラリ、または直接DOM操作で、SVG要素を生成し、HTMLドキュメントに挿入。
    4.  必要に応じて、ズーム、パン、コンポーネントのドラッグなどのインタラクティブ機能を追加。

### 6.3. 実装の考慮事項

*   **コンポーネントのシンボルライブラリ**:
    *   各`type`（例: `resistor`, `led`）に対応する標準的なSVGシンボル（または描画ロジック）を事前に定義しておく必要があります。これにより、YAMLに`type: "resistor"`と記述するだけで、適切な抵抗のシンボルが描画されます。
    *   カスタムコンポーネントや複雑なコンポーネントの場合、そのシンボルを別途定義し、YAMLから参照できるようにすることも考えられます。
*   **接続のルーティング**:
    *   コンポーネント間の接続線をどのように描画するかは、回路図の見やすさに大きく影響します。単純な直線だけでなく、直角に曲がる線や、他のコンポーネントを避けるようなルーティングアルゴリズムが必要になる場合があります。
    *   特に`junction`コンポーネントは、複数の接続を一点に集約するため、その周囲の配線が複雑になりがちです。
*   **階層構造の処理**:
    *   `module`コンポーネントの場合、モジュール自体の位置と回転を適用した後、`internal_components`の`position`（相対位置）を絶対位置に変換して描画する必要があります。
    *   モジュールの境界線を描画して、内部のコンポーネントをグループ化すると、視覚的に分かりやすくなります。
*   **座標系の変換**:
    *   SVGは左上を原点とする座標系を使用します。YAMLの`position`と`rotation`をSVGの`transform`属性や個別の属性に適切にマッピングする必要があります。
*   **インタラクティブ性**:
    *   生成されたSVGをWebブラウザで表示する場合、ズーム、パン、コンポーネントの選択、ドラッグなどのインタラクティブ機能を追加することで、ユーザーエクスペリエンスが向上します。これは主にフロントエンドでの生成時に考慮されます。
