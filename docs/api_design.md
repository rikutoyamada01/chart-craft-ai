## 9. API設計 (v2)

リファクタリングに伴い、回路図の管理とレンダリングに関するAPIをv2として再設計します。

**ベースURL**: `/api/v1`

### 9.1. 設計思想

- **責務の分離 (Separation of Concerns)**: アーキテクチャを以下の3層に明確に分割します。
    1.  **APIルート**: HTTPリクエストの受付とレスポンスの返却に専念します。
    2.  **サービス層**: レンダリングなどのコアなビジネスロジックをカプセル化します。
    3.  **CRUD層**: データベースとのインタラクションを抽象化します。
- **リソース指向 (Resource-Oriented)**: 回路定義を「リソース」として扱い、`/circuits` エンドポイントを通じて標準的なHTTPメソッド (GET, POST, PUT, DELETE) で操作します。
- **ステートレスなレンダリング (Stateless Rendering)**: `/circuits/render` エンドポイントにより、回路定義を保存することなく、その場でレンダリングしてプレビューする機能を提供します。

### 9.2. APIエンドポイント仕様

#### 9.2.1. 回路定義の管理 (CRUD)

- **`POST /circuits/`**
    - **説明**: 新しい回路定義を作成し、データベースに保存します。
    - **リクエストボディ**: `CircuitCreate` スキーマ (例: `{ "name": "My Circuit", "content": "<YAML...>" }`)
    - **レスポンス (201 Created)**: 作成されたリソースの情報 (`CircuitInDB` スキーマ、IDやタイムスタンプを含む)

- **`GET /circuits/`**
    - **説明**: 保存されているすべての回路定義のリストを取得します。
    - **レスポンス (200 OK)**: `list[CircuitInDB]`

- **`GET /circuits/{circuit_id}`**
    - **説明**: 指定されたIDの単一の回路定義を取得します。
    - **レスポンス (200 OK)**: `CircuitInDB`

- **`PUT /circuits/{circuit_id}`**
    - **説明**: 既存の回路定義を更新します。
    - **リクエストボディ**: `CircuitUpdate` スキーマ
    - **レスポンス (200 OK)**: 更新されたリソースの情報 (`CircuitInDB`)

- **`DELETE /circuits/{circuit_id}`**
    - **説明**: 指定されたIDの回路定義を削除します。
    - **レスポンス (204 No Content)**

#### 9.2.2. 回路図のレンダリング

- **`POST /circuits/render`**
    - **説明**: リクエストボディで提供された回路定義をその場でレンダリングします（保存はしません）。リアルタイムプレビュー用です。
    - **リクエストボディ**: `{ "content": "<YAMLデータ>" }`
    - **レスポンス (200 OK)**: レンダリングされた画像データ (例: `image/svg+xml`)

- **`GET /circuits/{circuit_id}/render`**
    - **説明**: 保存済みの回路定義をIDで指定してレンダリングします。
    - **レスポンス (200 OK)**: レンダリングされた画像データ (例: `image/svg+xml`)

### 9.3. その他の考慮事項

- **認証・認可**: v2設計でも同様に、本番環境ではAPIキーやOAuth2などの認証・認可メカニズムの導入が別途必要です。
- **バリデーション**: リクエストで受け取ったYAMLデータの妥当性検証は、各エンドポイントの責務の範囲内（主にサービス層）で行われます。独立した`/validate`エンドポイントは廃止し、各操作の事前条件として組み込みます。
